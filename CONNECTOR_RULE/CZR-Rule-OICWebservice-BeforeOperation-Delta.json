{
  "description": "This rule modifies the Web Services connector request before performing operations like testConnection, aggregation, etc., ensuring the Content-Type header is removed.",
  "type": "WebServiceBeforeOperationRule",
  "signature": {
    "input": [
      {
        "name": "application",
        "description": "The application whose data file is being processed.",
        "type": "sailpoint.object.Application"
      },
      {
        "name": "requestEndPoint",
        "description": "The current request information containing headers, body, context URL, method type, response attribute map, and successful response code.",
        "type": "sailpoint.connector.webservices.EndPoint"
      },
      {
        "name": "oldResponseMap",
        "description": "Earlier response object.",
        "type": "java.util.Map"
      },
      {
        "name": "restClient",
        "description": "REST Client Object.",
        "type": "sailpoint.connector.webservices.WebServicesClient"
      }
    ],
    "output": {
      "name": "EndPoint",
      "description": "Updated EndPoint Object.",
      "type": "sailpoint.connector.webservices.EndPoint"
    }
  },
  "sourceCode": {
    "version": "1.0",
    "script": "import java.util.Map;\r\nimport java.util.HashMap; \r\nimport java.util.Date;\r\nimport java.util.Calendar;\r\nimport java.util.List; \r\nimport java.util.ArrayList; \r\nimport java.net.URL;\r\nimport sailpoint.tools.Util;\r\nimport java.text.SimpleDateFormat;\r\nimport connector.common.JsonUtil;\r\nimport sailpoint.connector.webservices.WebServicesClient;\r\nimport java.util.Base64;\r\n\r\npublic String getISCAccessToken(WebServicesClient client, String tokenUrl, String clientId, String clientSecret) {\r\n    String accessToken = null;\r\n    try {\r\n        if (null != tokenUrl && null != clientId && null != clientSecret) {\r\n            Map header = new HashMap();\r\n            String credentials = clientId + \":\" + clientSecret;\r\n            String encodedCredentials = Base64.getEncoder().encodeToString(credentials.getBytes(\"UTF-8\"));\r\n\r\n            header.put(\"Accept\", \"application/json\");\r\n            header.put(\"Authorization\", \"Basic \" + encodedCredentials);\r\n\r\n            List allowedStatuses = new ArrayList();\r\n            allowedStatuses.add(\"2**\");\r\n\r\n            String response = client.executePost(tokenUrl, null, header, allowedStatuses);\r\n            if (sailpoint.tools.Util.isNotNullOrEmpty(response)) {\r\n                Map responseMap = JsonUtil.toMap(response);\r\n                if (null != responseMap && responseMap.containsKey(\"access_token\")) {\r\n                    accessToken = (String) responseMap.get(\"access_token\");\r\n                }\r\n            }\r\n        }\r\n    } catch (Exception e) {\r\n        log.error(\"CZR-Rule-OICWebservice-BeforeOperation-Delta:getISCAccessToken:Exception: \" + e.getLocalizedMessage(), e);\r\n        throw new sailpoint.tools.GeneralException(\"getISCAccessToken:Exception: \" + e.getLocalizedMessage(), e);\r\n    }\r\n    return accessToken;\r\n}\r\n\r\npublic Map getLastTaskCompletionDetails(WebServicesClient client, String accessToken, String baseUrl, String sourceId) {\r\n    Map taskDetails = new HashMap();\r\n    try {\r\n        if (null != baseUrl && null != accessToken && null != sourceId) {\r\n            String fullUrl = baseUrl + \"/beta/task-status?limit=2&offset=0&count=false&filters=sourceId+eq+%22\" + sourceId + \"%22+and+type+in+%28%22CLOUD_ACCOUNT_AGGREGATION%22%29&sorters=-created\";\r\n\t\t\r\n            log.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: fullUrl = \" + fullUrl);\r\n\t\t\tMap header = new HashMap();\r\n\t\t\t\t\t\t\t\t\t   \r\n            header.put(\"Accept\", \"application/json\");\r\n            header.put(\"Authorization\", \"Bearer \" + accessToken);\r\n\r\n            List allowedStatuses = new ArrayList();\r\n            allowedStatuses.add(\"2**\");\r\n\r\n            String response = client.executeGet(fullUrl, header, allowedStatuses);\r\n\t\t\tlog.info(\"CZR-Rule-OICWebservice-BeforeOperation: response = \" + response);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t \r\n\r\n                if (sailpoint.tools.Util.isNotNullOrEmpty(response)) {\r\n                    List responseList = JsonUtil.toList(response);\r\n\t\t\t\t\tlog.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: getLastTaskCompletionDetails responseCode = \" + responseCode);\r\n                    if (null != responseList && !responseList.isEmpty()) {\r\n                        Map latestTask = (Map) responseList.get(1); // Get the most recent task\r\n                        log.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: latestTask keys = \" + latestTask.keySet());\r\n                        log.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: raw latestTask = \" + latestTask.values());\r\n\t\t\t\t\t\t\r\n                        if (latestTask != null) {\r\n                            String completionStatus = (String) latestTask.get(\"completionStatus\");\r\n                            String createdTimestamp = (String) latestTask.get(\"created\"); \r\n\r\n                            log.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: completionStatus = \" + completionStatus);\r\n                            log.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: createdTimestamp = \" + createdTimestamp);\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  \r\n                            if (sailpoint.tools.Util.isNotNullOrEmpty(completionStatus)) {\r\n                                taskDetails.put(\"success\", \"SUCCESS\".equalsIgnoreCase(completionStatus));\r\n                            }\r\n                            if (sailpoint.tools.Util.isNotNullOrEmpty(createdTimestamp)) {\r\n                                taskDetails.put(\"timestamp\", createdTimestamp);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\t\t\t  \r\n        }\r\n  \r\n    } catch (Exception e) {\r\n        log.error(\"CZR-Rule-OICWebservice-BeforeOperation-Delta:getLastTaskCompletionDetails:Exception: \" + e.getMessage(), e);\r\n    }\r\n    log.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: taskDetails = \" + taskDetails);\r\n  \r\n    return taskDetails;\r\n}\r\n\r\n//Remove Content-Type headerMap\r\nMap headerMap = requestEndPoint.getHeader();\r\nif (null != headerMap && headerMap.containsKey(\"Content-Type\")) {\r\n    headerMap.remove(\"Content-Type\");\r\n    requestEndPoint.setHeader(headerMap);\r\n}\r\n\r\nString changeDate = null;\r\nString previousHitTime = null; \r\nString nextHitTime = null;     \r\n\r\ntry {\r\n    Map transientValues = (Map) application.getAttributeValue(\"transientValues\"); \r\n    if (null != transientValues) {\r\n        String startRow = (String) transientValues.get(\"StartRow\");\r\n        String endRow = (String) transientValues.get(\"EndRow\");\r\n        changeDate = (String) transientValues.get(\"changeDate\");\r\n\r\n        String urlString = (String) requestEndPoint.getFullUrl();\r\n\r\n        if (Util.isNotNullOrEmpty(startRow) && Util.isNotNullOrEmpty(endRow)) {\r\n            URL tempUrl = new URL(urlString);\r\n            String queryString = tempUrl.getQuery();\r\n            if (Util.isNotNullOrEmpty(queryString)) {\r\n                StringBuffer queryParams = new StringBuffer();\r\n                String[] params = queryString.split(\"&\");\r\n                for (String param : params) {\r\n                    if (queryParams.length() > 0)\r\n                        queryParams.append(\"&\");\r\n                    if (param.startsWith(\"StartRow=\")) {\r\n                        queryParams.append(\"StartRow=\");\r\n                        queryParams.append(startRow);\r\n                    } else if (param.startsWith(\"EndRow=\")) {\r\n\t\t\t\t\t\t\t\t\t\t   \r\n                        queryParams.append(\"EndRow=\");\r\n                        queryParams.append(endRow);\r\n                    } else {\r\n\t\t   \r\n                        queryParams.append(param);\r\n                    }\r\n                }\r\n                urlString = urlString.replace(queryString, queryParams.toString());\r\n            }\r\n            requestEndPoint.setFullUrl(urlString);\r\n        }\r\n    } else { \r\n        boolean lastAggSucceeded = false;\r\n        String lastAggTimestamp = null;\r\n\r\n\t\tWebServicesClient client = new WebServicesClient();\r\n        String baseUrl = application.getAttributeValue(\"iscBaseUrl\");\r\n        String clientId = application.getAttributeValue(\"iscClientId_CA\");\r\n        String clientSecret = application.getAttributeValue(\"iscClientSecret_CA\");\r\n        String sourceId = application.getAttributeValue(\"oicSourceId\");\r\n\r\n        String tokenUrl = baseUrl + \"/oauth/token?grant_type=client_credentials\";\r\n        Map args = new HashMap();\r\n        args.put(WebServicesClient.ARG_URL, tokenUrl);\r\n        client.configure(args);\r\n\r\n        String accessToken = getISCAccessToken(client, tokenUrl, clientId, clientSecret);\r\n        if (sailpoint.tools.Util.isNotNullOrEmpty(accessToken)) {\r\n            Map taskDetails = getLastTaskCompletionDetails(client, accessToken, baseUrl, sourceId);\r\n            if (taskDetails != null && taskDetails.get(\"success\") != null) {\r\n                lastAggSucceeded = (Boolean) taskDetails.get(\"success\");\r\n                lastAggTimestamp = (String) taskDetails.get(\"timestamp\");\r\n\r\n                log.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: lastAggSucceeded = \" + lastAggSucceeded);\r\n                log.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: lastAggTimestamp = \" + lastAggTimestamp);\r\n            }\r\n        } else {\r\n            log.warn(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: Could not retrieve ISC Access Token. Cannot determine last aggregation status.\");\r\n            throw new sailpoint.tools.GeneralException(\"Cannot retrieve ISC Access Token. Unable to proceed with delta aggregation logic.\");\r\n        }\r\n\r\n        previousHitTime = (String) application.getAttributeValue(\"changeEndpointPreviousHitTime\");\r\n        nextHitTime = (String) application.getAttributeValue(\"changeEndpointNextHitTime\");\r\n\r\n        log.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: previousHitTime = \" + previousHitTime);\r\n        log.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: nextHitTime = \" + nextHitTime);\r\n\r\n        if (previousHitTime == null && nextHitTime == null) {\r\n            log.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: First time delta. PreviousHitTime and NextHitTime are null.\");\r\n            if (lastAggSucceeded && sailpoint.tools.Util.isNotNullOrEmpty(lastAggTimestamp)) {\r\n                changeDate = lastAggTimestamp;\r\n                application.setAttribute(\"changeEndpointPreviousHitTime\", changeDate);\r\n                log.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: Set changeDate and changeEndpointPreviousHitTime to last successful aggregation timestamp: \" + changeDate);\r\n            } else {\r\n                log.error(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: First delta run, but last aggregation was not successful or timestamp is missing. LastAggSucceeded: \" + lastAggSucceeded + \", LastAggTimestamp: \" + lastAggTimestamp);\r\n                throw new sailpoint.tools.GeneralException(\"First delta run cannot proceed: Last full aggregation was not successful or its timestamp is unavailable.\");\r\n            }\r\n        } else if (!lastAggSucceeded && previousHitTime != null) { \r\n            changeDate = previousHitTime;\r\n            log.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: Last aggregation failed. Using previousHitTime for changeDate: \" + changeDate);\r\n        } else if (nextHitTime != null) { \r\n            changeDate = nextHitTime;\r\n            log.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: Last aggregation succeeded. Using nextHitTime for changeDate: \" + changeDate);\r\n        } else {\r\n            log.warn(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: Unexpected state for previousHitTime/nextHitTime. Defaulting changeDate to null. This may cause issues. PreviousHitTime: \" + previousHitTime + \", NextHitTime: \" + nextHitTime + \", LastAggSucceeded: \" + lastAggSucceeded);\r\n        }\r\n\r\n        transientValues = (Map) application.getAttributeValue(\"transientValues\"); \r\n        if (transientValues == null) {\r\n            transientValues = new HashMap();\r\n            application.setAttribute(\"transientValues\", transientValues);\r\n        }\r\n\r\n        if (changeDate != null) {\r\n            transientValues.put(\"changeDate\", changeDate);\r\n            log.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: Stored changeDate in transientValues: \" + changeDate);\r\n        } else {\r\n            log.warn(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: changeDate is null before URL replacement. Aggregation might fetch all data or fail.\");\r\n        }\r\n    }\r\n\r\n    String tempUrl = null;\r\n    String urlString = (String) requestEndPoint.getFullUrl();\r\n    if (changeDate != null && urlString.indexOf(\"changeDate\") != -1) { \r\n        tempUrl = urlString.replace(\"changeDate\", changeDate); \r\n         log.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: Updated URL with changeDate. Original: \" + urlString + \", New: \" + tempUrl);\r\n    } else if (changeDate == null && urlString.indexOf(\"changeDate\") != -1) {\r\n        log.warn(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: changeDate is null, but URL contains 'changeDate' placeholder. URL will not be modified for date. URL: \" + urlString);\r\n    } else {\r\n        log.info(\"CZR-Rule-OICWebservice-BeforeOperation-Delta: changeDate is null or URL does not contain 'changeDate' placeholder. URL: \" + urlString);\r\n        tempUrl = urlString; \r\n    }\r\n    \r\n    if (tempUrl != null) { \r\n        requestEndPoint.setFullUrl(tempUrl);\r\n    }\r\n\r\n} catch (Exception e) {\r\n    log.error(\"Catch block running in OIC before operation rule:: \" + e.getMessage(), e);\r\n    throw new sailpoint.tools.GeneralException(\"Catch block running in OIC before operation rule:: \" + e.getLocalizedMessage());\r\n}\r\n\r\nreturn requestEndPoint;"
  },
  "attributes": {
    "sourceVersion": "1.0"
  },
  "id": "1d79aa0ec15f42eaa456be3e1ef8c5e8",
  "name": "CZR-Rule-OICWebservice-BeforeOperation-Delta",
  "created": "2025-06-05T21:07:36.107Z",
  "modified": "2025-08-05T23:32:28.283Z"
}