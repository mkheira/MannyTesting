{
  "description": "This rule is used by the Web Services connector to update parsed resource object. Create List of Objects which will later converted to Resource object.",
  "type": "WebServiceAfterOperationRule",
  "signature": {
    "input": [
      {
        "name": "application",
        "description": "The application whose data file is being processed.",
        "type": null
      },
      {
        "name": "requestEndPoint",
        "description": "The current request information contain header, body ,response object",
        "type": null
      },
      {
        "name": "processedResponseObject",
        "description": "Response Object processed by the Web services connector",
        "type": null
      },
      {
        "name": "rawResponseObject",
        "description": "Response Object returned from the end system",
        "type": null
      },
      {
        "name": "restClient",
        "description": "REST Client Object",
        "type": null
      }
    ],
    "output": {
      "name": "Update Account/Group List",
      "description": "Update information Map contains parsed list of accounts",
      "type": null
    }
  },
  "sourceCode": {
    "version": "1.0",
    "script": "import connector.common.JsonUtil;\r\nimport java.util.HashMap;\r\nimport java.util.Map;\r\nimport java.util.List;\r\nimport java.util.ArrayList;\r\nimport java.time.format.DateTimeFormatter;\r\nimport java.time.LocalDateTime;\r\nimport java.time.temporal.ChronoUnit;\r\nimport java.time.LocalDate;\r\nimport sailpoint.tools.Util;\r\nimport sailpoint.connector.webservices.WebServicesClient;\r\nimport java.util.Base64;\r\nimport java.nio.charset.StandardCharsets;\r\nimport java.net.URLEncoder;\r\n\r\npublic String getSafeString(Map map, String key) {\r\n    Object value = map.get(key);\r\n    if (value == null) {\r\n        return \"NULL\";\r\n    }\r\n    String str = String.valueOf(value);\r\n    return str.isEmpty() ? \"NULL\" : str;\r\n}\r\n\r\npublic String getOptionalString(Map map, String key) {\r\n    Object value = map.get(key);\r\n    if (value == null) {\r\n        return null;\r\n    }\r\n    String str = String.valueOf(value).trim(); \r\n    return str.isEmpty() ? null : str;\r\n}\r\n\r\npublic String getISCAccessToken(WebServicesClient client, String tokenUrl, String clientId, String clientSecret) {\r\n\tString accessToken = null;\r\n\ttry {\r\n\t\tif(null != tokenUrl && null != clientId && null != clientSecret) {\r\n\t\t\tMap header = new HashMap();\r\n\t\t\tString credentials = clientId + \":\" + clientSecret;\r\n\t\t\tString encodedCredentials = Base64.getEncoder().encodeToString(credentials.getBytes(\"UTF-8\"));\r\n\r\n            header.put(\"Accept\", \"application/json\");\r\n            header.put(\"Authorization\", \"Basic \" + encodedCredentials);\r\n\r\n            List allowedStatuses = new ArrayList();\r\n            allowedStatuses.add(\"2**\");\r\n\r\n            String response = client.executePost(tokenUrl, null, header, allowedStatuses);\r\n            if(sailpoint.tools.Util.isNotNullOrEmpty(response)) {\r\n                Map responseMap = JsonUtil.toMap(response);\r\n                if(null != responseMap && responseMap.containsKey(\"access_token\")){\r\n                    accessToken = (String) responseMap.get(\"access_token\");\r\n                }\r\n            }\r\n\t\t}            \r\n\t} catch (Exception e) {\r\n\t\tlog.error(\"CZR-Rule-OICWebservice-AfterOperation:getISCAccessToken:Exception: \" + e.getLocalizedMessage(), e);\r\n\t\tthrow new sailpoint.tools.GeneralException(\"getISCAccessToken:Exception: \" + e.getLocalizedMessage(), e);\r\n\t}\r\n\treturn accessToken;\r\n}\r\n\r\npublic Map getLinkAttributes(WebServicesClient client, String accessToken, String personNumber, String baseUrl, String sourceId) {\r\n\tMap linkAttributes = null;\r\n\ttry {\r\n\t\tif(null != baseUrl && null != accessToken && null != personNumber && null != sourceId) {\r\n\t\t\tString encodedPersonNumber = URLEncoder.encode(personNumber, \"UTF-8\");\r\n\t\t\tString encodedSourceId = URLEncoder.encode(sourceId, \"UTF-8\");\r\n\t\t\tString url = baseUrl + \"/v3/accounts?filters=nativeIdentity eq \\\"\" + encodedPersonNumber + \"\\\" and sourceId eq \\\"\" + encodedSourceId + \"\\\"\";\r\n            Map header = new HashMap();\r\n            header.put(\"Accept\", \"application/json\");\r\n            header.put(\"Authorization\", \"Bearer \" + accessToken);\r\n\r\n            List allowedStatuses = new ArrayList();\r\n            allowedStatuses.add(\"2**\");\r\n            \r\n            String response = client.executeGet(url, header, allowedStatuses);\r\n\r\n            if (Util.isNotNullOrEmpty(response)) {\r\n                List accounts = JsonUtil.toList(response);\r\n                if (accounts != null && !accounts.isEmpty()) {\r\n                    Map account = (Map) accounts.get(0);\r\n                    if (account != null && account.containsKey(\"attributes\")) {\r\n                        Map attributes = (Map) account.get(\"attributes\");\r\n                        if (attributes != null && attributes.containsKey(\"assignments\")) {\r\n                            linkAttributes = attributes;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    } catch (Exception e) {\r\n        log.error(\"getLinkAttributes: Exception while fetching attributes for \" + personNumber + \": \" + e.getLocalizedMessage(), e);\r\n\t\tthrow new sailpoint.tools.GeneralException(\"getLinkAttributes: Exception for \" + personNumber + \": \" + e.getLocalizedMessage(), e);\r\n    }\r\n\r\n\treturn linkAttributes;\r\n}\r\n\r\npublic Map collectChildData(List linkAssignments, List allAssignments) {\r\n\tList primRecords = new ArrayList();\r\n\r\n\tfor(String eachAssignments : allAssignments){\r\n\t\tMap eachAssignmentsMap = JsonUtil.toMap(eachAssignments);\r\n\r\n        String childPosition     = getSafeString(eachAssignmentsMap, \"PositionName\");\r\n        String childDivision     = getSafeString(eachAssignmentsMap, \"Division\");\r\n        String childLoc          = getSafeString(eachAssignmentsMap, \"LocationCode\");\r\n        String childAssignNo     = getSafeString(eachAssignmentsMap, \"AssignmentNumber\");\r\n        String childAssignStatus = getSafeString(eachAssignmentsMap, \"AssignmentStatusType\");\r\n        String childPrimAssign   = getSafeString(eachAssignmentsMap, \"PrimaryAssignment\");\r\n        String childPrimWrk      = getSafeString(eachAssignmentsMap, \"PrimaryWorkRelationship\");\r\n        String childMngLevel     = getSafeString(eachAssignmentsMap, \"ManagementLevel\");\r\n        String childMngNumber    = getSafeString(eachAssignmentsMap, \"ManagerPersonNumber\");\r\n        String childAssignStart  = getSafeString(eachAssignmentsMap, \"AssignmentStartDate\");\r\n        String childAssignEnd    = getSafeString(eachAssignmentsMap, \"AssignmentEndDate\");\r\n\r\n        String childAll = childAssignNo + \"##\" + childPosition + \"##\" + childDivision + \"##\" + childLoc + \"##\" +\r\n                          childAssignStart + \"##\" + childAssignEnd + \"##\" + childAssignStatus + \"##\" + childMngLevel + \"##\" +\r\n                          childMngNumber + \"##\" + childPrimAssign + \"##\" + childPrimWrk;\r\n\t\t\t\t\r\n        // Safely remove existing matching assignments\r\n        for (int i = linkAssignments.size() - 1; i >= 0; i--) {\r\n            String linkEachAssignment = linkAssignments.get(i);\r\n            if (linkEachAssignment != null) {\r\n                String[] linkEachAssignmentArray = linkEachAssignment.split(\"##\");\r\n                if (linkEachAssignmentArray.length > 0) {\r\n                    String linkEachAssignmentNumber = linkEachAssignmentArray[0];\r\n                    if (linkEachAssignmentNumber != null && linkEachAssignmentNumber.equalsIgnoreCase(childAssignNo)) {\r\n                        linkAssignments.remove(i);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        String workerType = getSafeString(eachAssignmentsMap, \"WorkerType\");\r\n\r\n        if (\"Y\".equalsIgnoreCase(childPrimWrk) && \"Y\".equalsIgnoreCase(childPrimAssign)\r\n            || \"P\".equalsIgnoreCase(workerType)) {\r\n            primRecords.add(eachAssignmentsMap);\r\n        }\r\n\r\n        linkAssignments.add(childAll);\r\n    }\r\n\r\n    Map returnMap = new HashMap();\r\n    returnMap.put(\"primRecords\", primRecords);\r\n    returnMap.put(\"linkAssignments\", linkAssignments);\r\n    return returnMap;\t\t\t\r\n}\r\n\t\r\nMap updatedMapInfo = new HashMap();\r\nMap connectorStateMap = new HashMap();\r\nif(processedResponseObject != null) {\r\n\tMap transientValues = (Map) application.getAttributeValue(\"transientValues\");\r\n\tif(transientValues == null) {\r\n\t\ttransientValues = new HashMap();\r\n\t\tapplication.setAttribute(\"transientValues\", transientValues);\r\n\t}\r\n\r\n\tint StartRow = 1;\r\n\tint EndRow = 0;\r\n\r\n\ttry {\r\n\t\tURL url = new URL(requestEndPoint.getFullUrl());\r\n\t\tString[] params = url.getQuery().split(\"&\");\r\n\t\tfor (String param : params) {\r\n\t\t\tString[] pair = param.split(\"=\");\r\n\t\t\tif (pair.length == 2) {\r\n\t\t\t\tString name = pair[0];\r\n\t\t\t\tString value = pair[1];\r\n\t\t\t\tswitch (name) {\r\n\t\t\t\t\tcase \"StartRow\":\r\n\t\t\t\t\t\tStartRow = Integer.parseInt(value);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"EndRow\":\r\n\t\t\t\t\t\tEndRow = Integer.parseInt(value);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tlog.info(\"Delta aggregation pagination: StartRow=\" + StartRow + \", EndRow=\" + EndRow);\r\n\t} catch (Exception e) {\r\n\t\tlog.warn(\"Unable to parse StartRow/EndRow from requestEndPoint: \" + e.getMessage());\r\n\t}\r\n\r\n\tString iscBaseUrl = application.getAttributeValue(\"iscBaseUrl\");\r\n    String iscClientId_CA = application.getAttributeValue(\"iscClientId_CA\");\r\n    String iscClientSecret_CA = application.getAttributeValue(\"iscClientSecret_CA\");\r\n\tString sourceId = \"9f46913b2c9b4da5bc40734abda20886\"; \r\n\t\r\n\ttry {\r\n\t\tint count =0;\r\n\t\tString changeCount = transientValues.get(\"changeCount\");\r\n\t\tString fullCount = transientValues.get(\"fullCount\");\r\n\t\t\r\n\t\ttry {\r\n\t\t\tif (changeCount != null && !changeCount.equalsIgnoreCase(\"0\")) {\r\n\t\t\t\tcount = Integer.parseInt(changeCount);\r\n\t\t\t} else if (fullCount != null && !fullCount.equalsIgnoreCase(\"0\")) {\r\n\t\t\t\tcount = Integer.parseInt(fullCount);\r\n\t\t\t}\r\n\t\t} catch (NumberFormatException nfe) {\r\n\t\t\tlog.warn(\"Unable to parse count value: changeCount=\" + changeCount + \", fullCount=\" + fullCount, nfe);\r\n\t\t\tcount = 0; \r\n\t\t}\r\n\r\n\t\tString changeDateForNextHit =null;\r\n\t\tif (rawResponseObject != null && StartRow == 1) {\r\n\t\t\tMap rawResponseMap = JsonUtil.toMap(rawResponseObject);\r\n\t\t\tif (rawResponseMap != null) {\r\n\t\t\t\tObject dateValObj = rawResponseMap.get(\"InterfaceReturnDate\");\r\n\t\t\t\tif (dateValObj != null) {\r\n\t\t\t\t\tchangeDateForNextHit = String.valueOf(dateValObj);\r\n\t\t\t\t\tif (changeDateForNextHit.trim().isEmpty()) {\r\n\t\t\t\t\t\tchangeDateForNextHit = null;\r\n\t\t\t\t\t}\r\n\t\t\t\t\ttransientValues.put(\"changeDateForNextHit\", changeDateForNextHit);\r\n\t\t\t\t\tlog.warn(\"changeDateForNextHit set from response: \" + changeDateForNextHit);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tString changeDateCurrentfromMap = transientValues.get(\"changeDate\");\r\n\t\tString changeDateforNextfromMap = transientValues.get(\"changeDateForNextHit\");\r\n\r\n\t\tif(changeDateforNextfromMap!=null && changeDateCurrentfromMap!=null){\r\n\t\t\t\tconnectorStateMap.put(\"changeEndpointNextHitTime\", changeDateforNextfromMap);\r\n\t\t\t\tconnectorStateMap.put(\"changeEndpointPreviousHitTime\", changeDateCurrentfromMap);\r\n\t\t\t\tupdatedMapInfo.put(\"connectorStateMap\",connectorStateMap);\r\n\t\t\t}\r\n\t\tboolean hasMore = false;\r\n\t\tif (EndRow < count) {\r\n\t\t\thasMore = true;\r\n\t\t\ttransientValues.put(\"StartRow\", String.valueOf(EndRow + 1));\r\n\t\t\ttransientValues.put(\"EndRow\", String.valueOf(EndRow + 5000));  \r\n\t\t} else {\r\n\t\t\thasMore = false;\r\n\t\t\t// Only update connectorStateMap if this is the final page\r\n\t\t\tif (!updatedMapInfo.containsKey(\"connectorStateMap\") && changeDateforNextfromMap != null && changeDateCurrentfromMap != null) {\r\n\t\t\t\tconnectorStateMap.put(\"changeEndpointNextHitTime\", changeDateforNextfromMap);\r\n\t\t\t\tconnectorStateMap.put(\"changeEndpointPreviousHitTime\", changeDateCurrentfromMap);\r\n\t\t\t\tupdatedMapInfo.put(\"connectorStateMap\", connectorStateMap);\r\n\t\t\t}\r\n\t\t}\r\n\t\ttransientValues.put(\"hasMore\", hasMore);\t\r\n\t} catch(Exception e) {\r\n\t\tlog.error(\"Catch block running in OIC AfterOperation rule:: \" + e.getMessage(), e);\r\n\t\tthrow new sailpoint.tools.GeneralException(\"Catch block running in OIC AfterOperation rule:: \" + e.getLocalizedMessage(), e);\t\t\r\n\t}\r\n\t\r\n\t//parse assignments and get values from primay assignments\r\n\tif(null != processedResponseObject && !processedResponseObject.isEmpty()) {\r\n\t\tWebServicesClient client = new WebServicesClient();\r\n\t\tString tokenUrl = iscBaseUrl + \"/oauth/token?grant_type=client_credentials\";\r\n\t\tMap args = new HashMap();\r\n\t\targs.put(WebServicesClient.ARG_URL, tokenUrl);\r\n\t\tclient.configure(args); \r\n\r\n\t\tfinal int TOKEN_POOL_SIZE = 5;\r\n\r\n\t\tList accessTokenPool = new ArrayList();\r\n\r\n\t\tlog.info(\"Initializing token pool of size: \" + TOKEN_POOL_SIZE + \" for partition.\");\r\n\t\tfor (int i = 0; i < TOKEN_POOL_SIZE; i++) {\r\n\t\t\tString token = getISCAccessToken(client, tokenUrl, iscClientId_CA, iscClientSecret_CA);\r\n\t\t\tif (token == null) {\r\n\t\t\t\tlog.error(\"CRITICAL: Failed to get initial ISC Access Token for pool slot \" + i + \". Halting partition.\");\r\n\t\t\t\tthrow new sailpoint.tools.GeneralException(\"Failed to obtain initial ISC access token for pool slot \" + i);\r\n\t\t\t}\r\n\t\t\taccessTokenPool.add(token);\r\n\t\t\tlog.debug(\"Token pool: slot \" + i + \" initialized.\");\r\n\t\t}\r\n\t\tint currentTokenIndex = 0; // Index for selecting the next token to use\r\n\t\t// --- End Token Pool Setup ---\r\n\t\t\r\n\t\tfinal int MAX_RETRIES_PER_PERSON = 3; // Max retries for a single person's API call\r\n\t\tfinal long BASE_RETRY_PAUSE_MS_429 = 2000; // Start with 2s pause for 429, escalates per attempt\r\n\t\tfinal long RETRY_PAUSE_MS_401 = 500L;\t// Short 0.5s pause for 401 retry\r\n\r\n\t\tfor (Map object : (List) processedResponseObject)\r\n\t\t{\r\n\t\t\tString personNumber = getOptionalString(object, \"PersonNumber\");\r\n\t\t\tif (personNumber == null) { \r\n\t\t\t\tlog.error(\"PersonNumber is missing or invalid for an object. Skipping this record. Available keys: \" + object.keySet()); // Log a key or identifier\r\n\t\t\t\tcontinue; // Skip to the next object in processedResponseObject\r\n\t\t\t}\r\n            long overallStartTime = System.currentTimeMillis();\r\n\r\n            long s1StartTime, s1EndTime;\r\n\r\n\t\t\tMap appLink = null;\r\n\t\t\tList allAssignments = (List) object.get(\"assignments\");\r\n\t\t\tList linkAssignments = new ArrayList();\r\n\t\t\tboolean processedSuccessfully = false;\r\n\t\t\tint attemptsForThisPerson = 0;\r\n\r\n\t\t\twhile (attemptsForThisPerson <= MAX_RETRIES_PER_PERSON && !processedSuccessfully) \r\n\t\t\t{\r\n\t\t\t\tString tokenToUse = (String) accessTokenPool.get(currentTokenIndex); \r\n\t\t\t\tint tokenIndexOfCurrentAttempt = currentTokenIndex; \r\n\t\t\ttry\r\n\t\t\t{\r\n\t\t\t\t// --- SECTION 1: Get Link Attributes ---\r\n\t\t\t\ts1StartTime = System.currentTimeMillis();\r\n\t\t\t\tappLink = getLinkAttributes(client, tokenToUse, personNumber, iscBaseUrl, sourceId);\r\n\t\t\t\tif(null != appLink && appLink.containsKey(\"assignments\")) {\r\n\t\t\t\t\tObject assignmentsObj = appLink.get(\"assignments\");\r\n\t\t\t\t\tif (assignmentsObj instanceof List) {\r\n\t\t\t\t\t\tlinkAssignments = new ArrayList();\r\n\t\t\t\t\t\tList rawList = (List) assignmentsObj;\r\n\t\t\t\t\t\tfor (Object item : rawList) {\r\n\t\t\t\t\t\t\tif (item instanceof String) {\r\n\t\t\t\t\t\t\t\tlinkAssignments.add((String) item);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else if (assignmentsObj != null) {\r\n\t\t\t\t\t\tlog.warn(\"Expected 'assignments' in appLink to be a List, but found: \" + assignmentsObj.getClass().getName());\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\r\n\t\t\t\ts1EndTime = System.currentTimeMillis();\r\n\t\t\t\t// log.warn(\"Person \" + personNumber + \" - S1 (GetLinkAttrs) Time: \" + (s1EndTime - s1StartTime) + \" ms\");\r\n\t\t\t\t// --- END SECTION 1 ---\r\n\r\n\t\t\t\tprocessedSuccessfully = true;\r\n                // On full success for this user, advance the round-robin index for the *next* user\r\n                currentTokenIndex = (currentTokenIndex + 1) % TOKEN_POOL_SIZE;\r\n\r\n            } catch (sailpoint.tools.GeneralException ge) {\r\n                attemptsForThisPerson++;\r\n                String errorMessage = (ge.getMessage() != null) ? ge.getMessage().toLowerCase() : \"\";\r\n                log.warn(\"Person \" + personNumber + \" (Token Index \" + tokenIndexOfCurrentAttempt + \", Attempt \" + attemptsForThisPerson + \") - GeneralException: \" + ge.getMessage());\r\n\r\n                boolean is429 = errorMessage.contains(\"status: 429\") || errorMessage.contains(\"http code: 429\") || errorMessage.contains(\"429 too many requests\");\r\n                boolean is401 = errorMessage.contains(\"status: 401\") || errorMessage.contains(\"unauthorized\");\r\n\r\n                if (is429 || is401) {\r\n                    String reason = is429 ? \"429\" : \"401\";\r\n                    log.info(\"Reactively refreshing Token Index \" + tokenIndexOfCurrentAttempt + \" due to \" + reason + \" for person \" + personNumber);\r\n                    String newToken = getISCAccessToken(client, tokenUrl, iscClientId_CA, iscClientSecret_CA);\r\n                    if (newToken != null) {\r\n                        accessTokenPool.set(tokenIndexOfCurrentAttempt, newToken); // Refresh the specific token that failed\r\n                        log.info(\"Token Index \" + tokenIndexOfCurrentAttempt + \" reactively refreshed.\");\r\n                    } else {\r\n                        log.error(\"Failed to reactively refresh Token Index \" + tokenIndexOfCurrentAttempt + \" after \" + reason + \". That slot may be problematic for a bit.\");\r\n                    }\r\n                }\r\n\r\n                // For the NEXT retry attempt on THIS person, always use the next token in the pool\r\n                currentTokenIndex = (currentTokenIndex + 1) % TOKEN_POOL_SIZE;\r\n\r\n                if (attemptsForThisPerson <= MAX_RETRIES_PER_PERSON) {\r\n                    long pauseTime = is429 ? (BASE_RETRY_PAUSE_MS_429 * attemptsForThisPerson) : RETRY_PAUSE_MS_401;\r\n                    log.info(\"Pausing for \" + pauseTime + \"ms before retrying for \" + personNumber + \" (will use Token Index \" + currentTokenIndex + \").\");\r\n                } else {\r\n                    log.error(\"Person \" + personNumber + \" - Max retries (\" + MAX_RETRIES_PER_PERSON + \") reached. Skipping this person's API call.\");\r\n                }\r\n\r\n            } catch (Exception e) { // Catch any other unexpected exceptions during the API call phase\r\n                attemptsForThisPerson++;\r\n                log.error(\"Person \" + personNumber + \" (Token Index \" + tokenIndexOfCurrentAttempt + \", Attempt \" + attemptsForThisPerson + \") - Unexpected Exception: \" + e.getMessage(), e);\r\n                currentTokenIndex = (currentTokenIndex + 1) % TOKEN_POOL_SIZE; // Move to next token for retry\r\n                if (attemptsForThisPerson <= MAX_RETRIES_PER_PERSON) {\r\n                    long pauseTime = BASE_RETRY_PAUSE_MS_429 * attemptsForThisPerson * 2; // Longer pause for unexpected errors\r\n                    log.info(\"Pausing for \" + pauseTime + \"ms before retrying \" + personNumber + \" (unexpected error) with next token \" + currentTokenIndex);\r\n                } else {\r\n                     log.error(\"Person \" + personNumber + \" - Max retries reached after unexpected error. Skipping this person's API call.\");\r\n                }\r\n            }\r\n        } // End of while loop for retries for a single person\r\n\r\n        if (!processedSuccessfully) {\r\n            log.warn(\"Skipping further processing for Person \" + personNumber + \" as API call for link attributes failed after retries.\");\r\n            // currentTokenIndex is already advanced by the retry logic for the next user.\r\n            continue; // Move to the next person in the main loop\r\n        }\r\n\t\t\t\t// --- SECTION 2: Collect Child Data & Initial Assignment Processing ---\r\n\t\t\t\tList primRecords = new ArrayList();\r\n\t\t\t\tList finalValue = null;\t\r\n\t\t\t\tif(linkAssignments!=null && allAssignments!=null && linkAssignments.size()!=0 && allAssignments.size()!=0){ //For existing identity update\r\n\t\t\t\t\tMap returnMap = collectChildData(linkAssignments, allAssignments);\r\n\t\t\t\t\tif(returnMap != null) {\r\n\t\t\t\t\t\tObject finalValueObj = returnMap.get(\"linkAssignments\");\r\n\t\t\t\t\t\tif (finalValueObj instanceof List) {\r\n\t\t\t\t\t\t\tfinalValue = (List) finalValueObj;\r\n\t\t\t\t\t\t\tif(finalValue != null && !finalValue.isEmpty()) { \r\n\t\t\t\t\t\t\t\t object.put(\"assignments\", finalValue);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tObject primRecordsObj = returnMap.get(\"primRecords\");\r\n\t\t\t\t\t\tif (primRecordsObj instanceof List) {\r\n\t\t\t\t\t\t\tprimRecords = (List) primRecordsObj;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse { // For create new identity\r\n\t\t\t\t\tlinkAssignments.add(\"AssignmentNumber##PositionName##Division##LocationCode##AsgStartDate##AsgEndDate##AssignmentStatusType##ManagementLevel##ManagerPersonNumber##PrimaryAssignment##PrimaryWorkRelationship\");\r\n\t\t\t\t\tif(allAssignments != null && !allAssignments.isEmpty()) {\r\n\t\t\t\t\t\tMap returnMap = collectChildData(linkAssignments, allAssignments);\r\n\t\t\t\t\t\tif(returnMap != null) {\r\n\t\t\t\t\t\t\tObject finalValueObj = returnMap.get(\"linkAssignments\");\r\n\t\t\t\t\t\t\tif (finalValueObj instanceof List) {\r\n\t\t\t\t\t\t\t\tfinalValue = (List) finalValueObj;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t\tObject primRecordsObj = returnMap.get(\"primRecords\");\r\n\t\t\t\t\t\t\tif (primRecordsObj instanceof List) {\r\n\t\t\t\t\t\t\t\tprimRecords = (List) primRecordsObj;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(finalValue != null && !finalValue.isEmpty()) {\r\n\t\t\t\t\t\tobject.put(\"assignments\", finalValue);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tobject.put(\"assignments\", linkAssignments);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t// --- END SECTION 2 ---\r\n\r\n\t\t\t\t// --- SECTION 3: Primary Record (primRecord) Determination ---\r\n\t\t\t\tMap primRecord = null;\r\n\t\t\t\t\r\n\t\t\t\tif(primRecords!=null && primRecords.size()==1) {\r\n\t\t\t\t\tprimRecord = primRecords.get(0);\r\n\t\t\t\t}\r\n\t\t\t\telse if(primRecords!=null && primRecords.size()>1) {\r\n\t\t\t\t\tfor(Map eachPrimRecord : primRecords){\r\n\t\t\t\t\t\tString status = getSafeString(eachPrimRecord, \"AssignmentStatusType\");\r\n\t\t\t\t\t\tString workerTypeFromRec = getSafeString(eachPrimRecord, \"WorkerType\");\r\n\t\t\t\t\t\tString proStartDate = getOptionalString(eachPrimRecord, \"ProjectedStartDate\");\r\n\r\n\t\t\t\t\t\tif(status != null && workerTypeFromRec != null && status.equalsIgnoreCase(\"ACTIVE\") && workerTypeFromRec.equalsIgnoreCase(\"E\")) {\r\n\t\t\t\t\t\t\tprimRecord = eachPrimRecord;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse if(workerTypeFromRec !=null && workerTypeFromRec.equalsIgnoreCase(\"P\") && proStartDate!=null){\r\n\t\t\t\t\t\t\tDateTimeFormatter dtf = DateTimeFormatter.ofPattern(\"yyyy-MM-dd\");  \r\n\t\t\t\t\t\t\tLocalDateTime now = LocalDateTime.now();  \r\n\t\t\t\t\t\t\tString todayDate=(dtf.format(now));\r\n\r\n\t\t\t\t\t\t\tLocalDate dateBefore = LocalDate.parse(todayDate);\r\n\t\t\t\t\t\t\tLocalDate dateAfter = LocalDate.parse(proStartDate); \r\n\t\t\t\t\t\t\tlong daysDiff = ChronoUnit.DAYS.between(dateBefore, dateAfter);\r\n\t\t\t\t\t\t\tif(daysDiff>0){\r\n\t\t\t\t\t\t\t\tprimRecord = eachPrimRecord;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t\tif(primRecord==null && appLink!=null){\r\n\t\t\t\t\t\tString identityAsgNumber = getOptionalString(appLink, \"AssignmentNumber\"); \r\n\t\t\t\t\t\tif(identityAsgNumber!=null){\r\n\t\t\t\t\t\t\tfor(Map eachPrimRecord : primRecords){\r\n\t\t\t\t\t\t\t\tString asgNumber = getOptionalString(eachPrimRecord, \"AssignmentNumber\");\r\n\t\t\t\t\t\t\t\tif(asgNumber!=null && identityAsgNumber.equalsIgnoreCase(asgNumber)){\r\n\t\t\t\t\t\t\t\t\tprimRecord = eachPrimRecord;\r\n\t\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tif(primRecord==null){\r\n\t\t\t\t\t\tprimRecord = primRecords.get(0);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t// --- END SECTION 3 ---\r\n\r\n\t\t\t\t// --- SECTION 4: Attribute Population & Finalization ---\r\n\t\t\t\tString DepartmentName = null;\r\n\t\t\t\tString LocationCode = null;\r\n\t\t\t\tString AssignmentNumber = null;\r\n\t\t\t\tString AssignmentStatusType = null;\r\n\t\t\t\tString PrimaryAssignment = null;\r\n\t\t\t\tString PrimaryWorkRelationship = null;\r\n\t\t\t\tString ManagementLevel = null;\r\n\t\t\t\tString AssignmentStartDate = null;\r\n\t\t\t\tString AssignmentEndDate = null;\r\n\t\t\t\tString TerminationDate = null;\r\n\t\t\t\tString AssignmentStatusTypeCode = null;\r\n\t\t\t\tString AssignmentStatusTypeCodeMeaning = null;\r\n\t\t\t\tString AssignmentCategoryCode = null;\r\n\t\t\t\tString LOAStartDate = null;\r\n\t\t\t\tString BusinessUnit = null;\r\n\t\t\t\tString PropertyCode = null;\r\n\t\t\t\tString Division = null;\r\n\t\t\t\tString ManagerFullName = null;\r\n\t\t\t\tString ManagerPersonNumber = null;\r\n\t\t\t\tString PositionName = null;\r\n\t\t\t\tString Region = null;\r\n\t\t\t\tString WorkerType = null;\r\n\t\t\t\tString LocationName = null;\r\n\t\t\t\tString AssignmentCategoryCodeMeaning = null;\r\n\t\t\t\tString ProjectedStartDate = null;\r\n\t\t\t\tString PositionCode = null;\r\n\t\t\t\tString LegalEmployerName = null;\r\n\r\n\t\t\t\tif(primRecord != null){\r\n\t\t\t\t\tDepartmentName= primRecord.get(\"DepartmentName\");\r\n\t\t\t\t\tLocationCode=primRecord.get(\"LocationCode\");\r\n\t\t\t\t\tAssignmentNumber=primRecord.get(\"AssignmentNumber\");\r\n\t\t\t\t\tAssignmentStatusType=primRecord.get(\"AssignmentStatusType\");\r\n\t\t\t\t\tPrimaryAssignment=primRecord.get(\"PrimaryAssignment\");\r\n\t\t\t\t\tPrimaryWorkRelationship=primRecord.get(\"PrimaryWorkRelationship\");\r\n\t\t\t\t\tManagementLevel=primRecord.get(\"ManagementLevel\");\r\n\t\t\t\t\tAssignmentStartDate=primRecord.get(\"AssignmentStartDate\");\r\n\t\t\t\t\tAssignmentEndDate=primRecord.get(\"AssignmentEndDate\");\r\n\t\t\t\t\tTerminationDate=primRecord.get(\"TerminationDate\");\r\n\t\t\t\t\tAssignmentStatusTypeCode=primRecord.get(\"AssignmentStatusTypeCode\");\r\n\t\t\t\t\tAssignmentStatusTypeCodeMeaning=primRecord.get(\"AssignmentStatusTypeCodeMeaning\");\r\n\t\t\t\t\tAssignmentCategoryCode=primRecord.get(\"AssignmentCategoryCode\");\r\n\t\t\t\t\tLOAStartDate=primRecord.get(\"LOAStartDate\");\r\n\t\t\t\t\tBusinessUnit=primRecord.get(\"BusinessUnit\");\r\n\t\t\t\t\tPropertyCode=primRecord.get(\"PropertyCode\");\r\n\t\t\t\t\tDivision=primRecord.get(\"Division\");\r\n\t\t\t\t\tManagerFullName=primRecord.get(\"ManagerFullName\");\r\n\t\t\t\t\tManagerPersonNumber=primRecord.get(\"ManagerPersonNumber\");\r\n\t\t\t\t\tPositionName=primRecord.get(\"PositionName\");\r\n\t\t\t\t\tRegion=primRecord.get(\"Region\");\r\n\t\t\t\t\tWorkerType=primRecord.get(\"WorkerType\");\r\n\t\t\t\t\tLocationName=primRecord.get(\"LocationName\");\r\n\t\t\t\t\tAssignmentCategoryCodeMeaning=primRecord.get(\"AssignmentCategoryCodeMeaning\");\r\n\t\t\t\t\tProjectedStartDate=primRecord.get(\"ProjectedStartDate\");\r\n\t\t\t\t\tPositionCode=primRecord.get(\"PositionCode\");\r\n\t\t\t\t\tLegalEmployerName=primRecord.get(\"LegalEmployerName\");\r\n\t\t\t\t} else if(appLink!=null && appLink.size()!=0 ){\r\n\t\t\t\t\tDepartmentName= appLink.get(\"DepartmentName\");\r\n\t\t\t\t\tLocationCode=appLink.get(\"LocationCode\");\r\n\t\t\t\t\tAssignmentNumber=appLink.get(\"AssignmentNumber\");\r\n\t\t\t\t\tAssignmentStatusType=appLink.get(\"AssignmentStatusType\");\r\n\t\t\t\t\tPrimaryAssignment=appLink.get(\"PrimaryAssignment\");\r\n\t\t\t\t\tPrimaryWorkRelationship=appLink.get(\"PrimaryWorkRelationship\");\r\n\t\t\t\t\tManagementLevel=appLink.get(\"ManagementLevel\");\r\n\t\t\t\t\tAssignmentStartDate=appLink.get(\"AsgStartDate\");\r\n\t\t\t\t\tAssignmentEndDate=appLink.get(\"AsgEndDate\");\r\n\t\t\t\t\tTerminationDate=appLink.get(\"TerminationDate\");\r\n\t\t\t\t\tAssignmentStatusTypeCode=appLink.get(\"AssignmentStatusTypeCode\");\r\n\t\t\t\t\tAssignmentStatusTypeCodeMeaning=appLink.get(\"AssignmentStatusTypeCodeMeaning\");\r\n\t\t\t\t\tAssignmentCategoryCode=appLink.get(\"AssignmentCategoryCode\");\r\n\t\t\t\t\tLOAStartDate=appLink.get(\"LOAStartDate\");\r\n\t\t\t\t\tBusinessUnit=appLink.get(\"BusinessUnit\");\r\n\t\t\t\t\tPropertyCode=appLink.get(\"PropertyCode\");\r\n\t\t\t\t\tDivision=appLink.get(\"Division\");\r\n\t\t\t\t\tManagerFullName=appLink.get(\"ManagerFullName\");\r\n\t\t\t\t\tManagerPersonNumber=appLink.get(\"ManagerPersonNumber\");\r\n\t\t\t\t\tPositionName=appLink.get(\"PositionName\");\r\n\t\t\t\t\tRegion=appLink.get(\"Region\");\r\n\t\t\t\t\tWorkerType=appLink.get(\"WorkerType\");\r\n\t\t\t\t\tLocationName=appLink.get(\"LocationName\");\r\n\t\t\t\t\tAssignmentCategoryCodeMeaning=appLink.get(\"AssignmentCategoryCodeMeaning\");\r\n\t\t\t\t\tProjectedStartDate=appLink.get(\"ProjectedStartDate\");\r\n\t\t\t\t\tPositionCode=appLink.get(\"PositionCode\");\r\n\t\t\t\t\tLegalEmployerName=appLink.get(\"LegalEmployerName\");\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif(DepartmentName!=null)\r\n\t\t\t\t\tobject.put(\"DepartmentName\",DepartmentName);\r\n\t\t\t\tif(LocationCode!=null)\r\n\t\t\t\t\tobject.put(\"LocationCode\",LocationCode);\r\n\t\t\t\tif(AssignmentNumber!=null)\r\n\t\t\t\t\tobject.put(\"AssignmentNumber\",AssignmentNumber);\r\n\t\t\t\tif(AssignmentStatusType!=null)\r\n\t\t\t\t\tobject.put(\"AssignmentStatusType\",AssignmentStatusType); \r\n\t\t\t\tif(PrimaryAssignment!=null)\r\n\t\t\t\t\tobject.put(\"PrimaryAssignment\",PrimaryAssignment);\r\n\t\t\t\tif(PrimaryWorkRelationship!=null)\r\n\t\t\t\t\tobject.put(\"PrimaryWorkRelationship\",PrimaryWorkRelationship);\r\n\t\t\t\tif(ManagementLevel!=null)\r\n\t\t\t\t\tobject.put(\"ManagementLevel\",ManagementLevel);\r\n\t\t\t\tif(AssignmentStartDate!=null)\r\n\t\t\t\t\tobject.put(\"AsgStartDate\",AssignmentStartDate);\r\n\t\t\t\tif(AssignmentEndDate!=null)\r\n\t\t\t\t\tobject.put(\"AsgEndDate\",AssignmentEndDate);\r\n\t\t\t\tif(TerminationDate!=null)\r\n\t\t\t\t\tobject.put(\"TerminationDate\",TerminationDate);\r\n\t\t\t\tif(AssignmentStatusTypeCode!=null)\r\n\t\t\t\t\tobject.put(\"AssignmentStatusTypeCode\",AssignmentStatusTypeCode);\r\n\t\t\t\tif(AssignmentStatusTypeCodeMeaning!=null)\r\n\t\t\t\t\tobject.put(\"AsgStatusMeaning\",AssignmentStatusTypeCodeMeaning);\r\n\t\t\t\tif(AssignmentCategoryCode!=null)\r\n\t\t\t\t\tobject.put(\"AsgCategoryCode\",AssignmentCategoryCode);\r\n\t\t\t\tif(LOAStartDate!=null)\r\n\t\t\t\t\tobject.put(\"LOAStartDate\",LOAStartDate);\r\n\t\t\t\tif(BusinessUnit!=null)\r\n\t\t\t\t\tobject.put(\"BusinessUnitName\",BusinessUnit);\r\n\t\t\t\tif(PropertyCode!=null)\r\n\t\t\t\t\tobject.put(\"PropertyCode\",PropertyCode);\r\n\t\t\t\tif(Division!=null)\r\n\t\t\t\t\tobject.put(\"Division\",Division);\r\n\t\t\t\tif(ManagerFullName!=null)\r\n\t\t\t\t\tobject.put(\"ManagerFullName\",ManagerFullName);\r\n\t\t\t\tif(ManagerPersonNumber!=null)\r\n\t\t\t\t\tobject.put(\"ManagerPersonNumber\",ManagerPersonNumber);\r\n\t\t\t\tif(PositionName!=null)\r\n\t\t\t\t\tobject.put(\"PositionName\",PositionName);\r\n\t\t\t\tif(Region!=null)\r\n\t\t\t\t\tobject.put(\"Region\",Region);\r\n\t\t\t\tif(WorkerType!=null)\r\n\t\t\t\t\tobject.put(\"WorkerType\",WorkerType);\r\n\t\t\t\tif(DepartmentName!=null)\r\n\t\t\t\t\tobject.put(\"LocationName\",LocationName);\r\n\t\t\t\tif(AssignmentCategoryCodeMeaning!=null)\r\n\t\t\t\t\tobject.put(\"AsgCategoryMeaning\",AssignmentCategoryCodeMeaning);\r\n\t\t\t\tif(ProjectedStartDate!=null)\r\n\t\t\t\t\tobject.put(\"ProjectedStartDate\",ProjectedStartDate);\r\n\t\t\t\tif(DepartmentName!=null)\r\n\t\t\t\t\tobject.put(\"PositionCode\",PositionCode);\r\n\t\t\t\tif(LegalEmployerName!=null)\r\n\t\t\t\t\tobject.put(\"LegalEmployerName\",LegalEmployerName);\r\n\r\n\t\t\t\tif(AssignmentStatusType!=null && AssignmentStatusType.equalsIgnoreCase(\"INACTIVE\")){\r\n\t\t\t\t\tobject.put(\"IIQDisabled\",true);\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\tobject.put(\"IIQDisabled\",false);\r\n\t\t\t\t}\r\n\t\t\t\t// --- END SECTION 4 ---\r\n\t\t}\r\n\t}\r\n\r\n\tupdatedMapInfo.put(\"data\", processedResponseObject);\r\n}\r\n\r\nreturn updatedMapInfo;"
  },
  "attributes": {
    "sourceVersion": "1.0"
  },
  "id": "9efe0fe8d47d49599b251d93fa7ba126",
  "name": "CZR-Rule-OICWebservice-AfterOperation-Delta",
  "created": "2025-06-06T16:59:01.723Z",
  "modified": "2025-08-12T14:03:13.853Z"
}